<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>Social Network for Music</title>
    <!-- Bootstrap -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ"
      crossorigin="anonymous"
    />
    <!-- Icone -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.2/font/bootstrap-icons.css"
      integrity="sha384-b6lVK+yci+bfDmaY1u0zE8YYJt0TZxLEAFyYSLHId4xoVvsrQu3INevFKo+Xir8e"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <!-- Style.css -->
    <link rel="stylesheet" href="./style/style-home.css" />
  </head>
  <body>
    <!-- ======= Header ======= -->
    <header
      id="header"
      class="header fixed-top d-flex align-items-center justify-content-between"
    >
      <div class="d-flex align-items-center justify-content-between w-50">
        <i class="bi bi-list toggle-sidebar-btn"></i>
        <a href="home.html" class="logo d-flex align-items-center">
          <i class="fa-solid fa-headphones fa-2xl me-3"></i>
          <span class="d-none d-lg-block">SNM</span>
        </a>
      </div>
      <div class="nav-item dropdown pe-3">
        <a
          class="nav-link nav-profile d-flex align-items-center pe-0"
          href="#"
          data-bs-toggle="dropdown"
        >
          <img
            src="./img/profile.png"
            alt="profile"
            style="width: 25px; height: 25px; border-radius: 50%"
          />
          <span
            class="d-none d-md-block dropdown-toggle ps-2"
            id="usernameHeader"
            >Username</span
          >
        </a>

        <ul class="dropdown-menu dropdown-menu-end dropdown-menu-arrow profile">
          <li class="dropdown-header" id="nominativoHeader">
            <h6>Nome Cognome</h6>
          </li>
          <li>
            <hr class="dropdown-divider" />
          </li>

          <li>
            <a class="dropdown-item d-flex align-items-center" href="/profile">
              <i class="bi bi-person"></i>
              <span>Il mio profilo</span>
            </a>
          </li>
          <li>
            <hr class="dropdown-divider" />
          </li>
          <li>
            <a class="dropdown-item d-flex align-items-center" href="/logout">
              <i class="bi bi-box-arrow-right"></i>
              <span>Logout</span>
            </a>
          </li>
        </ul>
      </div>
    </header>
    <!-- ======= Sidebar ======= -->
    <aside id="sidebar" class="sidebar">
      <ul class="sidebar-nav" id="sidebar-nav">
        <li class="nav-item">
          <a class="nav-link collapsed" href="/home">
            <i class="bi bi-grid"></i>
            <span>Homepage</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link collapsed" href="/profile">
            <i class="bi bi-person"></i>
            <span>Profilo</span>
          </a>
        </li>
        <li class="nav-heading">Scopri</li>
        <li class="nav-item">
          <a class="nav-link collapsed" href="/tracks">
            <i class="bi bi-music-note"></i>
            <span>Brani</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link collapsed" href="/publicPlaylist">
            <i class="bi bi-music-note-list"></i>
            <span>Playlist</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/myPlaylist">
            <i class="bi bi-file-music"></i>
            <span>Le mie playlists</span>
          </a>
        </li>
      </ul>
    </aside>
    <!-- ======= Main ======= -->
    <div class="main" id="main">
      <div class="page-name mb-3">
        <a class="btn btn-custom" href="/myPlaylist">
          <i class="fa-solid fa-arrow-left fa-lg"></i>
        </a>
        <h1 class="text-center mt-4">
          Crea una nuova playlist e condividila su SNM
        </h1>
      </div>
      <div class="m-auto my-4 p-3 border-0" id="create-form-container">
        <form action="" method="POST" id="create-form">
          <label for="nome" class="form-label">Titolo</label>
          <input
            type="text"
            class="form-control mb-3"
            placeholder="Inserisci il titolo"
            id="titolo"
            name="titolo"
          />
          <label class="form-label">Descrizione</label>
          <textarea
            type="text"
            class="form-control mb-3"
            placeholder="Inserisci una descrizione"
            id="descrizione"
            name="descrizione"
          ></textarea>
          <label class="form-label">Tags</label>
          <input
            type="text"
            class="form-control mb-1"
            placeholder="Inserisci i tags"
            id="tags"
            name="tags"
            onkeydown="tagInput(event)"
            data-bs-toggle="collapse"
            href="#collapseExample"
            role="button"
            aria-expanded="false"
            aria-controls="collapseExample"
          />
          <input type="hidden" id="tags-hidden" name="tags-hidden" value="[]" />
          <div class="collapse" id="collapseExample">
            <p class="text-secondary mb-2" id="tag-desc">
              Per inserire un tag scrivere il nome (una sequenza di caratteri
              senza spazi) e premere spazio.
            </p>
          </div>

          <div class="tags-container mb-2" id="tags-container"></div>
          <div class="form-check form-switch">
            <input
              class="form-check-input"
              type="checkbox"
              role="switch"
              id="èPrivata"
              name="èPrivata"
            />
            <label class="form-check-label" for="flexSwitchCheckDefault"
              >Playlist privata</label
            >
          </div>
          <button
            type="submit"
            class="btn btn-custom w-100 mt-4"
            style="font-size: 14px"
          >
            Conferma
          </button>
        </form>
        <div
          id="form-alert"
          class="alert alert-danger mt-3"
          style="display: none"
        ></div>
        <div
          id="form-success"
          class="alert alert-success mt-3"
          style="display: none"
        ></div>
      </div>
    </div>
    <script src="./main.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/typed.js@2.0.16/dist/typed.umd.js"></script>
    <script>
      function tagInput(event) {
        if (event.keyCode === 32) {
          event.preventDefault();
          const tagsInput = document.getElementById('tags');
          const tagText = tagsInput.value.trim();

          if (tagText !== '') {
            const tagsContainer = document.getElementById('tags-container');
            const tagBadge = document.createElement('span');
            tagBadge.classList.add('badge', 'me-1', 'tag-badge');
            tagBadge.textContent = tagText;

            const removeButton = document.createElement('span');
            removeButton.classList.add('tag-remove');
            removeButton.innerHTML = '&nbsp; &times;';
            removeButton.addEventListener('mouseover', () => {
              removeButton.style.cursor = 'pointer';
            });
            removeButton.addEventListener('click', () => {
              tagsContainer.removeChild(tagBadge);
              const tagsHidden = document.getElementById('tags-hidden');
              const currentTags = JSON.parse(tagsHidden.value);
              const index = currentTags.indexOf(tagText);
              if (index > -1) {
                currentTags.splice(index, 1);
              }
              tagsHidden.value = JSON.stringify(currentTags);
            });

            tagBadge.appendChild(removeButton);
            tagsContainer.appendChild(tagBadge);

            tagsInput.value = '';

            const tagsHidden = document.getElementById('tags-hidden');
            const currentTags =
              tagsHidden.value === '' ? [] : JSON.parse(tagsHidden.value);
            currentTags.push(...tagText.split(','));
            tagsHidden.value = JSON.stringify(currentTags);
          }
        }
      }

      const form = document.getElementById('create-form');
      const privateCheckbox = document.getElementById('èPrivata');
      const alert = document.getElementById('form-alert');
      const succes = document.getElementById('form-success');
      form.addEventListener('submit', async (event) => {
        event.preventDefault();
        const formData = new FormData(form);
        const tagsHidden = document.getElementById('tags-hidden');
        const currentTags = JSON.parse(tagsHidden.value);
        formData.append('tags', currentTags);
        const isPrivate = privateCheckbox.checked;
        privateCheckbox.value = isPrivate.toString();
        formData.append('èPrivata', privateCheckbox.value);
        try {
          const response = await fetch('/create-playlist', {
            method: 'POST',
            body: JSON.stringify(Object.fromEntries(formData)),
            headers: {
              'Content-Type': 'application/json',
            },
          });
          if (response.status === 200) {
            alert.style.display = 'none';
            succes.style.display = 'block';
            succes.textContent = 'Playlist creata con successo';
            form.reset();
            const tagsContainer = document.getElementById('tags-container');
            tagsContainer.innerHTML = '';
            tagsHidden.value = '[]';
          } else {
            const err = await response.json();
            succes.style.display = 'none';
            alert.style.display = 'block';
            alert.textContent = err.error;
          }
        } catch (error) {
          console.error(error);
        }
      });
    </script>
  </body>
</html>
