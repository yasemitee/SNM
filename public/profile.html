<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>Social Network for Music</title>
    <link rel="icon" href="./img/headphones-solid.svg" type="image/x-icon" />
    <!-- Font -->
    <!-- <link rel="preconnect" href="https://rsms.me/" />
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css" /> -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Lato:wght@100;300;400;700;900&display=swap"
      rel="stylesheet"
    />
    <!-- Bootstrap -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ"
      crossorigin="anonymous"
    />
    <!-- Icone -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.2/font/bootstrap-icons.css"
      integrity="sha384-b6lVK+yci+bfDmaY1u0zE8YYJt0TZxLEAFyYSLHId4xoVvsrQu3INevFKo+Xir8e"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <!-- Style.css -->
    <link rel="stylesheet" href="./style/style-home.css" />
  </head>
  <body>
    <!-- ======= Header ======= -->
    <header
      id="header"
      class="header fixed-top d-flex align-items-center justify-content-between"
    >
      <div class="d-flex align-items-center justify-content-between w-50">
        <i class="bi bi-list toggle-sidebar-btn"></i>
        <a href="home.html" class="logo d-flex align-items-center">
          <i class="fa-solid fa-headphones fa-2xl me-3"></i>
          <span class="d-none d-lg-block">SNM</span>
        </a>
      </div>
      <div class="nav-item dropdown pe-3">
        <a
          class="nav-link nav-profile d-flex align-items-center pe-0"
          href="#"
          data-bs-toggle="dropdown"
        >
          <img
            src="./img/profile.png"
            alt="profile"
            style="width: 25px; height: 25px; border-radius: 50%"
          />
          <span
            class="d-none d-md-block dropdown-toggle ps-2"
            id="usernameHeader"
            >Username</span
          >
        </a>

        <ul class="dropdown-menu dropdown-menu-end dropdown-menu-arrow profile">
          <li class="dropdown-header" id="nominativoHeader">
            <h6>Nome Cognome</h6>
          </li>
          <li>
            <hr class="dropdown-divider" />
          </li>

          <li>
            <a class="dropdown-item d-flex align-items-center" href="/profile">
              <i class="bi bi-person"></i>
              <span>Il mio profilo</span>
            </a>
          </li>
          <li>
            <hr class="dropdown-divider" />
          </li>
          <li>
            <a class="dropdown-item d-flex align-items-center" href="/logout">
              <i class="bi bi-box-arrow-right"></i>
              <span>Logout</span>
            </a>
          </li>
        </ul>
      </div>
    </header>
    <!-- ======= Sidebar ======= -->
    <aside id="sidebar" class="sidebar">
      <ul class="sidebar-nav" id="sidebar-nav">
        <li class="nav-item">
          <a class="nav-link collapsed" href="/home">
            <i class="bi bi-grid"></i>
            <span>Homepage</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/profile">
            <i class="bi bi-person"></i>
            <span>Profilo</span>
          </a>
        </li>
        <li class="nav-heading">Scopri</li>
        <li class="nav-item">
          <a class="nav-link collapsed" href="/tracks">
            <i class="bi bi-music-note"></i>
            <span>Brani</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link collapsed" href="/publicPlaylist">
            <i class="bi bi-music-note-list"></i>
            <span>Playlists</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link collapsed" href="/myPlaylist">
            <i class="bi bi-file-music"></i>
            <span>Le mie playlist</span>
          </a>
        </li>
      </ul>
    </aside>
    <!-- ======= Main ======= -->
    <div class="main" id="main">
      <section class="profile d-md-flex">
        <div
          class="my-4 p-3 pe-0 pt-0 d-flex align-items-center position-relative align-self-start"
          id="inf"
        >
          <div class="img">
            <img
              src="./img/profile.png"
              alt="Avatar"
              class="avatar"
              style="width: 140px; height: 140px; border-radius: 50%"
            />
          </div>
          <div id="info" class="ms-4 mt-4">
            <div class="d-flex fw-bold">
              <h1 id="nominativo"></h1>
            </div>
            <h5 class="d-flex text-lowercase text-secondary fw-semibold">
              <span>@</span>
              <div id="username"></div>
            </h5>
            <h5 class="d-flex mb-4 text-lowercase text-secondary">
              <div id="email"></div>
            </h5>
            <a type="button" class="btn btn-custom" href="/editProfile">
              <span class="text-white">
                <i class="fa-solid fa-pen-to-square"></i>
                Edit
              </span>
            </a>
          </div>
          <div class="logout position-absolute" style="top: 0px; right: 0px">
            <h6>
              <i
                class="fa-solid fa-right-from-bracket"
                style="color: #ff7000"
              ></i>
              <a href="/logout" class="fw-semibold">Logout</a>
            </h6>
          </div>
        </div>
        <div class="my-4 p-3 pe-0 pt-0 ms-md-3 align-self-start" id="pfr">
          <h1 class="mt-4">Preferenze musicali</h1>
          <div class="preferenze my-3">
            <div class="fav-artist">
              <div class="search-bar" style="padding: 0">
                <form
                  class="search-form d-flex align-items-center w-100"
                  method="POST"
                  action="#"
                >
                  <input
                    type="text"
                    name="query"
                    placeholder="&#xF002; Cerca artisti preferiti..."
                    style="
                      font-family: Arial, FontAwesome;
                      border-radius: 50px;
                      height: 48px;
                    "
                  />
                  <select
                    class="btn btn-custom dropdown-toggle"
                    style="
                      background-color: #ff7000;
                      color: #fff;
                      height: 32px;
                      width: 100px;
                    "
                  >
                    <option selected value="1">Artisti</option>
                    <option value="2">Generi</option>
                  </select>
                </form>
                <ul class="dropdown-menu w-25"></ul>
              </div>
            </div>
            <div class="fav-genre d-none">
              <div class="search-bar" style="padding: 0">
                <form
                  class="search-form d-flex align-items-center w-100"
                  method="POST"
                  action="#"
                >
                  <input
                    type="text"
                    name="query"
                    placeholder="&#xF002; Cerca generi preferiti..."
                    style="
                      font-family: Arial, FontAwesome;
                      border-radius: 50px;
                      height: 48px;
                    "
                  />
                  <select
                    class="btn btn-custom dropdown-toggle"
                    style="
                      background-color: #ff7000;
                      color: #fff;
                      height: 32px;
                      width: 100px;
                    "
                  >
                    <option selected value="2">Generi</option>
                    <option value="1">Artisti</option>
                  </select>
                </form>
                <ul class="dropdown-menu w-25"></ul>
              </div>
            </div>
          </div>
        </div>
      </section>
      <div class="my-playlist">
        <div class="mt-4 p-3 pe-0 pt-0">
          <h1>Le mie playlist</h1>
          <a href="/myPlaylist" class="btn btn-custom mt-2">
            <span class="text-white">
              <i class="fa-solid fa-plus"></i>
              Crea playlist
            </span>
          </a>
          <div class="cards-container mt-4">
            <div
              class="playlist-cards mt-4 d-flex flex-wrap"
              id="playlist-cards"
            ></div>
          </div>
        </div>
      </div>
    </div>
    <script src="./main.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/typed.js@2.0.16/dist/typed.umd.js"></script>
    <script>
      (async () => {
        const nominativo = document.getElementById('nominativo');
        const username = document.getElementById('username');
        const email = document.getElementById('email');
        try {
          const response = await fetch('/get-user-info', {
            method: 'GET',
          });
          if (response.ok) {
            const r = await response.json();
            username.innerHTML = r.data.username;
            nominativo.innerHTML = r.data.nome + ' ' + r.data.cognome;
            email.innerHTML = r.data.email;
          }
        } catch (error) {
          console.error(error);
        }
      })();

      const searchArtist = document.querySelector('.fav-artist .search-form');
      const artistDropdown = document.querySelector(
        '.fav-artist .dropdown-menu'
      );
      const genreDropdown = document.querySelector('.fav-genre .dropdown-menu');

      searchArtist
        .querySelector('input[name="query"]')
        .addEventListener('input', async (e) => {
          const query = e.target.value;

          if (query.length > 1) {
            try {
              const response = await fetch(`/search-artist?artist=${query}`);
              const data = await response.json();
              const artists = data.data;
              artistDropdown.innerHTML = '';

              for (let i = 0; i < 5; i++) {
                const artistItem = document.createElement('li');
                artistItem.innerHTML = `
                <a class="dropdown-item" href="#" data-id="${artists[i].id}">${artists[i].name}</a>
                `;
                artistDropdown.appendChild(artistItem);
              }

              artistDropdown.style.display = 'block';
            } catch (error) {
              console.error(error);
            }
          } else {
            artistDropdown.style.display = 'none';
          }

          document.addEventListener('click', (e) => {
            if (!e.target.closest('.fav-artist')) {
              artistDropdown.style.display = 'none';
            }
          });
        });

      const selectPreferenceA = document.querySelector(
        '.fav-artist .search-bar select'
      );
      selectPreferenceA.addEventListener('change', (e) => {
        if (e.target.value === '1') {
          document.querySelector('.fav-artist').classList.remove('d-none');
          document.querySelector('.fav-genre').classList.add('d-none');
        } else {
          selectPreferenceB.value = '2';
          document.querySelector('.fav-artist').classList.add('d-none');
          document.querySelector('.fav-genre').classList.remove('d-none');
        }
      });

      const selectPreferenceB = document.querySelector(
        '.fav-genre .search-bar select'
      );
      selectPreferenceB.addEventListener('change', (e) => {
        if (e.target.value === '1') {
          selectPreferenceA.value = '1';
          document.querySelector('.fav-artist').classList.remove('d-none');
          document.querySelector('.fav-genre').classList.add('d-none');
        } else {
          document.querySelector('.fav-artist').classList.add('d-none');
          document.querySelector('.fav-genre').classList.remove('d-none');
        }
      });

      artistDropdown.addEventListener('click', async (e) => {
        if (e.target.classList.contains('dropdown-item')) {
          const artistId = e.target.dataset.id;
          try {
            const response = await fetch(
              `/add-favourite-artist?artistId=${artistId}`,
              {
                method: 'POST',
              }
            );
            if (response.status === 200) {
              console.log('artista preferito aggiunto');
              window.location.href = '/profile';
            } else {
              const err = await response.json();
              console.log(err.error);
            }
          } catch (error) {
            console.log(error);
          }
        }
      });

      (async () => {
        try {
          const response = await fetch('/get-favourite-artists', {
            method: 'GET',
          });
          if (response.ok) {
            const r = await response.json();
            const artists = r.data.artistiPreferiti;
            console.log(artists);
            const favArtist = document.querySelector('.fav-artist');
            const badgeContainer = document.createElement('div');
            badgeContainer.classList.add('my-3', 'd-flex', 'flex-wrap');
            favArtist.appendChild(badgeContainer);
            console.log(badgeContainer);
            artists.forEach((artist) => {
              const badge = document.createElement('span');
              badge.classList.add('badge', 'me-2', 'mb-2');
              badge.innerText = artist.nome;
              const removeBtn = document.createElement('button');
              removeBtn.classList.add('btn', 'btn-sm', 'ms-1', 'pe-0');
              removeBtn.innerHTML = '<i class="fa-solid fa-x fa-2xs"></i>';
              removeBtn.addEventListener('click', async () => {
                try {
                  const response = await fetch(
                    `/remove-favourite-artist?artistId=${artist.id}`,
                    {
                      method: 'DELETE',
                    }
                  );
                  if (response.status === 200) {
                    console.log('artista preferito rimosso');
                    window.location.href = '/profile';
                  } else {
                    const err = await response.json();
                    console.log(err.error);
                  }
                } catch (error) {
                  console.log(error);
                }
              });
              badge.appendChild(removeBtn);
              badgeContainer.appendChild(badge);
            });
          }
        } catch (error) {
          console.error(error);
        }
      })();
      const searchGenre = document.querySelector('.fav-genre .search-form');
      (async () => {
        try {
          const response = await fetch('/get-available-genres', {
            method: 'GET',
          });
          if (response.ok) {
            const r = await response.json();
            const genres = r.data.genres;
            console.log(genres);
            searchGenre
              .querySelector('input[name="query"]')
              .addEventListener('input', (e) => {
                const query = e.target.value;
                genreDropdown.innerHTML = '';
                if (query.length > 0) {
                  const filteredGenres = genres.filter((genre) =>
                    genre.toLowerCase().includes(query.toLowerCase())
                  );
                  console.log(filteredGenres);
                  for (let i = 0; i < filteredGenres.length; i++) {
                    if (i === 5) break;
                    const genreItem = document.createElement('li');
                    genreItem.innerHTML = `
                    <a class="dropdown-item" href="#">${filteredGenres[i]}</a>
                    `;
                    genreDropdown.appendChild(genreItem);
                  }
                  genreDropdown.style.display = 'block';
                } else {
                  genreDropdown.style.display = 'none';
                }
              });
          }
        } catch (error) {
          console.error(error);
        }
      })();

      genreDropdown.addEventListener('click', async (e) => {
        if (e.target.classList.contains('dropdown-item')) {
          const genre = e.target.innerText;
          try {
            const response = await fetch(
              `/add-favourite-genre?genre=${genre}`,
              {
                method: 'POST',
              }
            );
            if (response.status === 200) {
              console.log('genere preferito aggiunto');
              searchGenre.querySelector('input[name="query"]').value = '';
              genreDropdown.innerHTML = '';
              genreDropdown.style.display = 'none';
              favGen();
            } else {
              const err = await response.json();
              console.log(err.error);
            }
          } catch (error) {
            console.log(error);
          }
        }
      });

      async function favGen() {
        try {
          const response = await fetch('/get-favourite-genres', {
            method: 'GET',
          });
          if (response.ok) {
            const r = await response.json();
            const genres = r.data.generiPreferiti;
            console.log(genres);
            const favGenre = document.querySelector('.fav-genre');

            if (favGenre.querySelector('.my-3')) {
              favGenre.querySelector('.my-3').remove();
            }
            const badgeContainer = document.createElement('div');
            badgeContainer.classList.add('my-3', 'd-flex', 'flex-wrap');
            favGenre.appendChild(badgeContainer);
            console.log(badgeContainer);
            genres.forEach((genre) => {
              const badge = document.createElement('span');
              badge.classList.add('badge', 'me-2', 'mb-2');
              badge.innerText = genre;
              const removeBtn = document.createElement('button');
              removeBtn.classList.add('btn', 'btn-sm', 'ms-1', 'pe-0');
              removeBtn.innerHTML = '<i class="fa-solid fa-x fa-2xs"></i>';
              removeBtn.addEventListener('click', async () => {
                try {
                  const response = await fetch(
                    `/remove-favourite-genre?genre=${genre}`,
                    {
                      method: 'DELETE',
                    }
                  );
                  if (response.status === 200) {
                    console.log('genere preferito rimosso');
                    favGen();
                  } else {
                    const err = await response.json();
                    console.log(err.error);
                  }
                } catch (error) {
                  console.log(error);
                }
              });
              badge.appendChild(removeBtn);
              badgeContainer.appendChild(badge);
            });
          }
        } catch (error) {
          console.error(error);
        }
      }

      favGen();

      const playlistCards = document.getElementById('playlist-cards');

      fetch('/get-created-playlists')
        .then((response) => response.json())
        .then((data) => {
          if (data.status === 'ok') {
            if (data.data.length === 0) {
              const noPlaylist = document.createElement('h4');
              noPlaylist.classList.add('text-muted');
              noPlaylist.textContent = 'Non hai ancora creato playlist';
              playlistCards.appendChild(noPlaylist);
            }
            const playlists = data.data;
            playlists.forEach((playlist) => {
              const playlistCard = document.createElement('a');
              playlistCard.classList.add('card', 'mb-4', 'border-0');
              playlistCard.style.width = '170px';
              playlistCard.style.height = '170px';
              playlistCard.style.backgroundColor = '#FDFDFD';
              playlistCard.href = '/playlist/' + playlist._id;

              const img = document.createElement('div');
              img.style.position = 'relative';
              img.style.height = '120px';
              img.style.width = '120px';
              img.classList.add('card-img-top');
              if (playlist.tracce.length === 0) {
                const picture1 = document.createElement('img');
                picture1.classList.add('img-fluid');
                picture1.src = './img/playlist-default.png';
                img.appendChild(picture1);
              } else if (playlist.tracce.length === 1) {
                const picture1 = document.createElement('img');
                picture1.classList.add('img-fluid', 'rounded');
                picture1.src = playlist.tracce[0].immagine;
                img.appendChild(picture1);
              } else if (playlist.tracce.length <= 3) {
                img.classList.add('d-flex', 'justify-content-center');
                const picture1 = document.createElement('img');
                picture1.classList.add('img-fluid', 'rounded-start');
                picture1.style.objectFit = 'cover';
                picture1.style.maxWidth = '50%';
                picture1.src = playlist.tracce[0].immagine;
                img.appendChild(picture1);
                const picture2 = document.createElement('img');
                picture2.classList.add('img-fluid', 'rounded-end');
                picture2.style.objectFit = 'cover';
                picture2.style.maxWidth = '50%';
                picture2.src = playlist.tracce[1].immagine;
                img.appendChild(picture2);
              } else {
                img.classList.add('d-flex', 'justify-content-center');
                const picture1 = document.createElement('img');
                picture1.style.position = 'absolute';
                picture1.style.top = '0';
                picture1.style.left = '0';
                picture1.classList.add('img-fluid', 'w-50', 'rounded-top-left');
                picture1.src = playlist.tracce[0].immagine;
                img.appendChild(picture1);
                const picture2 = document.createElement('img');
                picture2.style.position = 'absolute';
                picture2.style.top = '0';
                picture2.style.right = '0';
                picture2.classList.add(
                  'img-fluid',
                  'w-50',
                  'rounded-top-right'
                );
                picture2.src = playlist.tracce[1].immagine;
                img.appendChild(picture2);
                const picture3 = document.createElement('img');
                picture3.style.position = 'absolute';
                picture3.style.bottom = '0';
                picture3.style.left = '0';
                picture3.classList.add(
                  'img-fluid',
                  'w-50',
                  'rounded-bottom-left'
                );
                picture3.src = playlist.tracce[2].immagine;
                img.appendChild(picture3);
                const picture4 = document.createElement('img');
                picture4.style.position = 'absolute';
                picture4.style.bottom = '0';
                picture4.style.right = '0';
                picture4.classList.add(
                  'img-fluid',
                  'w-50',
                  'rounded-bottom-right'
                );
                picture4.src = playlist.tracce[3].immagine;
                img.appendChild(picture4);
              }
              playlistCard.appendChild(img);

              const cardBody = document.createElement('div');
              const title = document.createElement('h4');
              title.classList.add('card-title', 'text-truncate', 'm-0', 'p-1');
              title.textContent = playlist.titolo;
              const owner = document.createElement('h5');
              owner.classList.add(
                'card-subtitle',
                'text-muted',
                'text-truncate',
                'px-1'
              );
              owner.textContent = 'Di ' + playlist.creatore;
              cardBody.appendChild(title);
              cardBody.appendChild(owner);
              playlistCard.appendChild(cardBody);
              playlistCards.appendChild(playlistCard);
            });
          } else {
            console.error('Errore nel recupero delle playlist:', data.error);
          }
        })
        .catch((error) => {
          console.error('Errore nella richiesta delle playlist:', error);
        });

      searchArtist.addEventListener('submit', (e) => {
        e.preventDefault();
      });

      searchGenre.addEventListener('submit', (e) => {
        e.preventDefault();
      });
    </script>
  </body>
</html>
